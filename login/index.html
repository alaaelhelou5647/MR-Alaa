<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://mr-alaa.vercel.app/logo.png" type="image/png">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
<script>
document.addEventListener("DOMContentLoaded", function () {

  const data = JSON.parse(localStorage.getItem("loggedStudent"));

  const gradeLinks = {
    "1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-1/",
    "2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-2/",
    "3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-3/",
    "1 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-1/",
    "2 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-2/",
    "3 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-3/"
  };

  if (data && data.grade) {

    const grade = data.grade.trim();

    const target = gradeLinks[grade];

    if (target) {
      location.replace(target); // ğŸ”¥ Ø£Ø³Ø±Ø¹ ØªÙˆØ¬ÙŠÙ‡ Ù…Ù…ÙƒÙ†
    } else {
      console.warn("Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©:", grade);
    }

  } else {
    console.warn("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.");
  }

});
</script>

</head>
<body>
    <div class="login-container">
                <div class="img">
            <img src="icone.png" alt="">
        </div>
        <!-- Session Info (Auto Login) -->
        <div class="session-info" id="sessionInfo">
            <div class="session-content">
                <div class="session-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="session-text">
                    <h4>Ù„Ø¯ÙŠÙƒ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©</h4>
                    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                </div>
            </div>
            <button class="auto-login-btn" id="autoLoginBtn">
                <i class="fas fa-bolt"></i> Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹
            </button>
        </div>

        <!-- Login Card -->
        <div class="login-card">
            <!-- Logo and Welcome -->
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ</h1>
                <p class="sub-text">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ø±ÙˆØ³Ùƒ</p>
            </div>

            <!-- Login Form -->
            <div class="input-group">
                <input type="text" id="loginID" class="input-field" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨ (ID)" autocomplete="username">
                <div class="input-icon">
                    <i class="fas fa-id-card"></i>
                </div>
            </div>

            <div class="input-group">
                <input type="password" id="loginPass" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
                <div class="input-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <button type="button" class="password-toggle" id="passwordToggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>

            <!-- Login Button -->
            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                <div class="loader" id="loginLoader"></div>
            </button>

            <!-- Forgot Password Link -->
            <div class="forgot-link">
                <button class="forgot-btn" id="forgotBtn">
                    <i class="fas fa-key"></i> Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
                </button>
            </div>

            <!-- Recovery Section (Hidden by default) -->
            <div class="recovery-section" id="recoverySection">
                <div class="recovery-title">
                    <i class="fas fa-unlock-alt"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                </div>

                <div class="input-group">
                    <input type="text" id="forgetName" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„">
                    <div class="input-icon">
                        <i class="fas fa-user-tag"></i>
                    </div>
                </div>

                <div class="input-group">
                    <input type="tel" id="forgetPhone" class="input-field" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨">
                    <div class="input-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                </div>

                <!-- Recovery Button -->
                <button class="recovery-btn" id="recoveryBtn">
                    <i class="fas fa-redo"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                    <div class="loader" id="recoveryLoader"></div>
                </button>

                <!-- Recovery Message -->
                <div class="message-box" id="recoveryMsg"></div>
            </div>

            <!-- Login Message -->
            <div class="message-box" id="loginMessage"></div>

            <!-- Register Link -->
            <div class="register-link">
                Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨Ø§Ù‹ØŸ <a href="register.html">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
            </div>
        </div>

    </div>



<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    
    <script>
// ØªÙ‡ÙŠØ¦Ø© Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBB-L6uhazoGVYg2lkphimDMbdjFhrfXjw",
    authDomain: "login-87618.firebaseapp.com",
    projectId: "login-87618",
    storageBucket: "login-87618.firebasestorage.app",
    messagingSenderId: "915916987311",
    appId: "1:915916987311:web:0da484d712d79b50916d5a"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase App
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
const AppState = {
    isProcessing: false,
    lastSession: null,
    autoLoginAttempted: false
};

// Ø«ÙˆØ§Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
const Constants = {
    GRADE_PAGES: {
        "1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "prep-1.html",
        "2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "prep-2.html",
        "3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "prep-3.html",
        "1 Ø«Ø§Ù†ÙˆÙŠ": "sec-1.html",
        "2 Ø«Ø§Ù†ÙˆÙŠ": "sec-2.html",
        "3 Ø«Ø§Ù†ÙˆÙŠ": "sec-3.html"
    },
    VALIDATION: {
        ID_REGEX: /^\d{4}$/,
        PHONE_REGEX: /^(010|011|012|015)\d{8}$/,
        MIN_PASSWORD_LENGTH: 4
    }
};

// DOM Elements
const Elements = {
    // Inputs
    loginID: document.getElementById('loginID'),
    loginPass: document.getElementById('loginPass'),
    forgetName: document.getElementById('forgetName'),
    forgetPhone: document.getElementById('forgetPhone'),
    
    // Buttons
    passwordToggle: document.getElementById('passwordToggle'),
    loginBtn: document.getElementById('loginBtn'),
    forgotBtn: document.getElementById('forgotBtn'),
    recoveryBtn: document.getElementById('recoveryBtn'),
    cancelAutoLogin: document.getElementById('cancelAutoLogin'),
    
    // Sections
    autoLoginOverlay: document.getElementById('autoLoginOverlay'),
    sessionInfo: document.getElementById('sessionInfo'),
    recoverySection: document.getElementById('recoverySection'),
    
    // Messages
    loginMessage: document.getElementById('loginMessage'),
    recoveryMsg: document.getElementById('recoveryMsg'),
    
    // Loaders
    loginLoader: document.getElementById('loginLoader'),
    recoveryLoader: document.getElementById('recoveryLoader')
};

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
async function initApp() {
    setupEventListeners();
    await testConnection();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    await attemptAutoLogin();
}

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
async function attemptAutoLogin() {
    try {
        const studentData = localStorage.getItem("loggedStudent");
        if (!studentData) {
            hideAutoLoginOverlay();
            return;
        }

        const data = JSON.parse(studentData);
        if (!data.id || !data.password) {
            localStorage.removeItem("loggedStudent");
            hideAutoLoginOverlay();
            return;
        }

        AppState.lastSession = data;
        AppState.autoLoginAttempted = true;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        showAutoLoginOverlay();

        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 1.5 Ø«Ø§Ù†ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        await new Promise(resolve => setTimeout(resolve, 1500));

        // ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const studentRef = db.collection("students").doc(data.id);
        const docSnap = await studentRef.get();

        if (!docSnap.exists) {
            localStorage.removeItem("loggedStudent");
            showAutoLoginError();
            return;
        }

        const student = docSnap.data();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        if (student.password !== data.password) {
            localStorage.removeItem("loggedStudent");
            showAutoLoginError();
            return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
        await studentRef.update({
            lastLogin: new Date().toISOString(),
            loginCount: (student.loginCount || 0) + 1
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        showAutoLoginSuccess();
        
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 1 Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
        setTimeout(() => {
            redirectToGradePage(student.grade);
        }, 1000);

    } catch (error) {
        console.error('Auto-login error:', error);
        showAutoLoginError();
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
function showAutoLoginOverlay() {
    if (Elements.autoLoginOverlay) {
        Elements.autoLoginOverlay.style.display = 'flex';
        setTimeout(() => {
            Elements.autoLoginOverlay.style.opacity = '1';
        }, 10);
    }
}

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
function hideAutoLoginOverlay() {
    if (Elements.autoLoginOverlay) {
        Elements.autoLoginOverlay.style.opacity = '0';
        setTimeout(() => {
            Elements.autoLoginOverlay.style.display = 'none';
        }, 500);
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
function showAutoLoginError() {
    const content = Elements.autoLoginOverlay.querySelector('.auto-login-content');
    if (content) {
        content.innerHTML = `
            <div class="auto-login-logo" style="color: var(--error);">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="auto-login-text">
                <h3 style="color: var(--error); margin-bottom: 10px;">ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
                <p style="color: var(--gray);">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹</p>
            </div>
            <button class="cancel-auto-login" onclick="hideAutoLoginOverlay()" style="background: var(--error); color: white;">
                <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹
            </button>
        `;
        
        setTimeout(hideAutoLoginOverlay, 3000);
    }
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
function showAutoLoginSuccess() {
    const content = Elements.autoLoginOverlay.querySelector('.auto-login-content');
    if (content) {
        content.innerHTML = `
            <div class="auto-login-logo" style="color: var(--success);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="auto-login-text">
                <h3 style="color: var(--success); margin-bottom: 10px;">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p style="color: var(--gray);">Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ</p>
            </div>
        `;
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
function setupEventListeners() {
    // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    Elements.passwordToggle.addEventListener('click', togglePassword);
    
    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    Elements.loginBtn.addEventListener('click', handleLogin);
    
    // Ø²Ø± Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    Elements.forgotBtn.addEventListener('click', toggleRecovery);
    
    // Ø²Ø± Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    Elements.recoveryBtn.addEventListener('click', handleRecovery);
    
    // Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    if (Elements.cancelAutoLogin) {
        Elements.cancelAutoLogin.addEventListener('click', hideAutoLoginOverlay);
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Enter
    Elements.loginPass.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    Elements.forgetPhone.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRecovery();
    });
    
    // Ù…Ø³Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    setupInputValidation();
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
function setupInputValidation() {
    const inputIds = ['loginID', 'loginPass', 'forgetName', 'forgetPhone'];
    
    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                this.classList.remove('shake');
                if (id.includes('login')) {
                    hideMessage('loginMessage');
                } else {
                    hideMessage('recoveryMsg');
                }
            });
        }
    });
}

// ====== Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ======
function togglePassword() {
    const passwordField = Elements.loginPass;
    const toggleIcon = Elements.passwordToggle.querySelector('i');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// ====== Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ======
function toggleRecovery() {
    Elements.recoverySection.classList.toggle('show');
    
    if (Elements.recoverySection.classList.contains('show')) {
        setTimeout(() => Elements.forgetName.focus(), 300);
    } else {
        resetRecoveryForm();
    }
}

function resetRecoveryForm() {
    Elements.forgetName.value = '';
    Elements.forgetPhone.value = '';
    hideMessage('recoveryMsg');
}

// ====== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ======
function validateLoginInputs() {
    const id = Elements.loginID.value.trim();
    const pass = Elements.loginPass.value.trim();
    let isValid = true;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù
    if (!id) {
        showInputError('loginID', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù');
        isValid = false;
    } else if (!Constants.VALIDATION.ID_REGEX.test(id)) {
        showInputError('loginID', 'Ø§Ù„Ù…Ø¹Ø±Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù…');
        isValid = false;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (!pass) {
        showInputError('loginPass', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        isValid = false;
    } else if (pass.length < Constants.VALIDATION.MIN_PASSWORD_LENGTH) {
        showInputError('loginPass', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹');
        isValid = false;
    }

    return isValid;
}

function validateRecoveryInputs() {
    const name = Elements.forgetName.value.trim();
    const phone = Elements.forgetPhone.value.trim();
    let isValid = true;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
    if (!name || name.split(" ").length < 3) {
        showMessage('recoveryMsg', 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹', 'error');
        isValid = false;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    if (!Constants.VALIDATION.PHONE_REGEX.test(phone)) {
        showMessage('recoveryMsg', 'âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015)', 'error');
        isValid = false;
    }

    return isValid;
}

function showInputError(inputId, message) {
    const input = document.getElementById(inputId);
    if (input) {
        input.classList.add('shake');
        showMessage('loginMessage', `âŒ ${message}`, 'error');
        setTimeout(() => {
            if (input) input.classList.remove('shake');
        }, 500);
    }
}

// ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ======
async function handleLogin() {
    if (AppState.isProcessing) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!validateLoginInputs()) return;

    const id = Elements.loginID.value.trim();
    const pass = Elements.loginPass.value.trim();

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    startProcessing('login');
    
    try {
        const studentRef = db.collection("students").doc(id);
        const docSnap = await studentRef.get();

        if (!docSnap.exists) {
            showMessage('loginMessage', 'âŒ Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
            showInputError('loginID', '');
            return;
        }

        const data = docSnap.data();
        await processLoginSuccess(data, studentRef);

    } catch (err) {
        console.error('Login error:', err);
        showMessage('loginMessage', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
    } finally {
        stopProcessing('login');
    }
}

async function processLoginSuccess(data, studentRef) {
    const pass = Elements.loginPass.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (data.password !== pass) {
        showMessage('loginMessage', 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        showInputError('loginPass', '');
        return;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
    await updateLastLogin(studentRef, data);

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    saveSessionData(data);

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
    showMessage('loginMessage', 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    redirectToGradePage(data.grade);

}

async function updateLastLogin(studentRef, data) {
    try {
        await studentRef.update({
            lastLogin: new Date().toISOString(),
            loginCount: (data.loginCount || 0) + 1
        });
    } catch (error) {
        console.error('Error updating last login:', error);
    }
}

function saveSessionData(data) {
    const sessionData = {
        id: data.id,
        name: data.name,
        grade: data.grade,
        studentPhone: data.studentPhone,
        password: data.password,
        lastLogin: new Date().toISOString()
    };

    localStorage.setItem("loggedStudent", JSON.stringify(sessionData));
}

// ====== Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ======
async function handleRecovery() {
    if (AppState.isProcessing) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!validateRecoveryInputs()) return;

    const name = Elements.forgetName.value.trim();
    const phone = Elements.forgetPhone.value.trim();

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    startProcessing('recovery');

    try {
        const snapshot = await db.collection("students")
            .where("studentPhone", "==", phone)
            .get();

        if (snapshot.empty) {
            showMessage('recoveryMsg', 'âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù†Ø¸Ø§Ù…Ù†Ø§', 'error');
            return;
        }

        const foundStudent = findMatchingStudent(snapshot, name);

        if (foundStudent) {
            await displayRecoveryInfo(foundStudent);
            await updateRecoveryTimestamp(foundStudent);
            scheduleRecoveryReset();
        } else {
            showMessage('recoveryMsg', 
                'âŒ Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¬Ù„<br><small>ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ Ø³Ø¬Ù„ØªÙ‡ ØªÙ…Ø§Ù…Ø§Ù‹</small>', 
                'error'
            );
        }

    } catch (err) {
        console.error('Recovery error:', err);
        showMessage('recoveryMsg', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹', 'error');
    } finally {
        stopProcessing('recovery');
    }
}

function findMatchingStudent(snapshot, name) {
    const normalizedInput = name.toLowerCase().replace(/\s+/g, ' ').trim();
    
    for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const normalizedStored = data.name.toLowerCase().replace(/\s+/g, ' ').trim();
        
        if (normalizedStored === normalizedInput) {
            return {
                ...data,
                docId: docSnap.id
            };
        }
    }
    
    return null;
}

async function displayRecoveryInfo(studentData) {
    const passwordHTML = `
        <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin:10px 0; 
                   font-family:monospace; text-align:center; font-size:18px; letter-spacing:2px;">
            ${studentData.password}
        </div>
    `;

    const message = `
        âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ
        <br><br>
        <strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> ${studentData.name}
        <br><strong>ğŸ“š Ø§Ù„ØµÙ:</strong> ${studentData.grade}
        <br><br>
        ğŸ”‘ <strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong> 
        ${passwordHTML}
        <small style="color:gray">âš ï¸ Ø§Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†</small>
    `;

    showMessage('recoveryMsg', message, 'success');
}

async function updateRecoveryTimestamp(studentData) {
    try {
        const studentRef = db.collection("students").doc(studentData.docId);
        await studentRef.update({
            lastPasswordRecovery: new Date().toISOString()
        });
    } catch (error) {
        console.error('Error updating recovery timestamp:', error);
    }
}

function scheduleRecoveryReset() {
    setTimeout(() => {
        if (Elements.recoverySection && Elements.recoverySection.classList.contains('show')) {
            toggleRecovery();
        }
    }, 8000);
}

// ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ======
function startProcessing(type) {
    AppState.isProcessing = true;
    const button = document.getElementById(type + 'Btn');
    const loader = document.getElementById(type + 'Loader');
    
    if (button) {
        button.disabled = true;
        button.classList.add('processing');
        
        if (!button.dataset.originalText) {
            button.dataset.originalText = button.innerHTML;
        }
        
        const tempText = type === 'login' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹...';
        const icon = button.querySelector('i');
        button.innerHTML = icon ? `${icon.outerHTML} ${tempText}` : tempText;
    }
    
    if (loader) {
        loader.style.display = 'inline-block';
    }
}

function stopProcessing(type) {
    AppState.isProcessing = false;
    const button = document.getElementById(type + 'Btn');
    const loader = document.getElementById(type + 'Loader');
    
    if (button) {
        button.disabled = false;
        button.classList.remove('processing');
        
        if (button.dataset.originalText) {
            button.innerHTML = button.dataset.originalText;
        }
    }
    
    if (loader) {
        loader.style.display = 'none';
    }
}

// ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======
function showMessage(elementId, message, type = 'info') {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = message;
        element.className = `message-box ${type}`;
        element.style.display = 'block';
        
        const hideTime = type === 'success' ? 10000 : 5000;
        setTimeout(() => {
            if (element && element.style.display !== 'none') {
                hideMessage(elementId);
            }
        }, hideTime);
    }
}

function hideMessage(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
        element.innerHTML = '';
    }
}

function redirectToGradePage(grade) {

  const fullLinks = {
    "1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-1",
    "2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-2",
    "3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-3",
    "1 Ø«Ø§Ù†ÙˆÙŠ": "/sec-1",
    "2 Ø«Ø§Ù†ÙˆÙŠ": "/sec-2",
    "3 Ø«Ø§Ù†ÙˆÙŠ": "/sec-3"
  };

  const target = fullLinks[grade];

  if (target) {
    location.replace(target); // ğŸš€ Ø§Ù„Ø£Ø³Ø±Ø¹
  } else {
    showMessage('loginMessage', `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ - Ø§Ù„ØµÙ "${grade}" ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…`, 'error');
  }
}


// ====== Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ======
async function testConnection() {
    try {
        const testRef = db.collection("students");
        const snapshot = await testRef.limit(1).get();
        console.log("âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ø¬Ø­");
        console.log("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:", snapshot.size);
        return true;
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:", error);
        showMessage('loginMessage', 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        return false;
    }
}


    </script>

</body>
</html>