<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://mr-alaa.vercel.app/logo.png" type="image/png">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script>
document.addEventListener("DOMContentLoaded", function () {

  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ø£ÙŠ ÙˆØ§Ø­Ø¯ ÙÙŠÙ‡Ù… Ù…ÙˆØ¬ÙˆØ¯
  const loggedStudent = JSON.parse(localStorage.getItem("loggedStudent"));
  const studentData = JSON.parse(localStorage.getItem("studentData"));

  // Ù†Ø®ØªØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙ‚Ø·
  const data = loggedStudent || studentData;

  const gradeLinks = {
    "1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-1/",
    "2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-2/",
    "3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "https://mr-alaa.vercel.app/prep-3/",
    "1 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-1/",
    "2 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-2/",
    "3 Ø«Ø§Ù†ÙˆÙŠ": "https://mr-alaa.vercel.app/sec-3/"
  };

  if (!data) {
    console.warn("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ loggedStudent ÙˆÙ„Ø§ studentData ÙÙŠ localStorage");
    return;
  }

  if (!data.grade) {
    console.warn("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ grade Ø¯Ø§Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨");
    return;
  }

  const grade = data.grade.trim();
  const target = gradeLinks[grade];

  if (target) {
    console.log("âœ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰:", target);
    location.replace(target); // ØªÙˆØ¬ÙŠÙ‡ ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ø±Ø¬ÙˆØ¹
  } else {
    console.warn("âš ï¸ ØµÙ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ:", grade);
  }

});
</script>

</head>
<body>
    <div class="page-layout">

        <!-- ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„Ø¬Ù†Ø¨ -->
        <div class="side-image">
            <img src="4fe4035e77e13a6c11c4539d799c1031 (1).jpg" alt="ØµÙˆØ±Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©">
        </div>

        <!-- Ø§Ù„ÙÙˆØ±Ù… ÙÙŠ Ø§Ù„Ø¬Ù†Ø¨ Ø§Ù„Ø¢Ø®Ø± -->
        <div class="card">
            <h2><i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>

            <label for="name">Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ</label>
            <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required>
            <div id="nameError" class="error-message">Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø«Ù„Ø§Ø«ÙŠÙ‹Ø§</div>

            <label for="studentPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input id="studentPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" maxlength="11">
            <div id="studentPhoneError" class="error-message">Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015)</div>

            <label for="parentPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±</label>
            <input id="parentPhone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" maxlength="11">
            <div id="parentPhoneError" class="error-message">Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>

            <label for="grade">Ø§Ù„ØµÙ</label>
            <select id="grade">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                <option>1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option>2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option>3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option>1 Ø«Ø§Ù†ÙˆÙŠ</option>
                <option>2 Ø«Ø§Ù†ÙˆÙŠ</option>
                <option>3 Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
            <div id="gradeError" class="error-message">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</div>

            <label for="gov">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
            <select id="gov">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                <option>Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                <option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
                <option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
                <option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                <option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
                <option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
                <option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
                <option>Ø£Ø³ÙŠÙˆØ·</option>
                <option>Ø³ÙˆÙ‡Ø§Ø¬</option>
            </select>
            <div id="govError" class="error-message">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</div>

            <label for="studentID">ID</label>
            <input id="studentID" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨" readonly>

            <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="password" type="password" placeholder="Ø§Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
            <div id="passwordError" class="error-message">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>

            <div class="loader" id="loader"></div>
            <button onclick="register()" id="registerBtn">
                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>

            <div class="result" id="result" style="display:none;">
                <h3><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p>ğŸ”“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­</p>

                <div class="login-card">
                    <p><i class="fas fa-id-card"></i> <b>Ù…Ø¹Ø±ÙÙƒ:</b> <span id="showID"></span></p>
                    <p><i class="fas fa-key"></i> <b>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</b> <span id="showPass"></span></p>
                    <p class="warning"><i class="fas fa-exclamation-triangle"></i> Ø§Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙŠØ¯Ù‹Ø§</p>
                </div>

                <button id="goPageBtn" onclick="goToGradePage()">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙÙƒ
                </button>
            </div>

            <p style="text-align: center; margin-top: 20px; color: var(--gray-text);">
                Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ  <a href="/login/" style="color: var(--primary-color);">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</a>
            </p>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBB-L6uhazoGVYg2lkphimDMbdjFhrfXjw",
            authDomain: "login-87618.firebaseapp.com",
            projectId: "login-87618",
            storageBucket: "login-87618.firebasestorage.app",
            messagingSenderId: "915916987311",
            appId: "1:915916987311:web:0da484d712d79b50916d5a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.collection = collection;
    </script>

    <script>
        // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        let usedPhones = new Set();

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯
        function generateID() {
            let id;
            do {
                id = Math.floor(1000 + Math.random() * 9000).toString();
            } while (localStorage.getItem(`student_${id}`));
            return id;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
        window.onload = async function() {
            // ØªÙˆÙ„ÙŠØ¯ ID Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById("studentID").value = generateID();
            
            // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
            await checkForExistingRegistration();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ù„Ù„Ù…Ø³ÙˆØ¯Ø©
            loadDraftData();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ
            setupInputValidation();
        };

        // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚
        async function checkForExistingRegistration() {
            const studentId = localStorage.getItem("currentStudentId");
            if (studentId) {
                try {
                    const studentRef = doc(db, "students", studentId);
                    const studentSnap = await getDoc(studentRef);
                    
                    if (studentSnap.exists()) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                        const data = studentSnap.data();
                        localStorage.setItem("lastGrade", data.grade);
                        showMessage("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹", "success");
                        setTimeout(() => goToGradePage(), 1500);
                    }
                } catch (err) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err);
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙƒÙ…Ø³ÙˆØ¯Ø©
        function loadDraftData() {
            const saved = localStorage.getItem("studentDraft");
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    document.getElementById("name").value = data.name || "";
                    document.getElementById("studentPhone").value = data.studentPhone || "";
                    document.getElementById("parentPhone").value = data.parentPhone || "";
                    document.getElementById("grade").value = data.grade || "";
                    document.getElementById("gov").value = data.governorate || "";
                    document.getElementById("password").value = data.password || "";
                    
                    if (data.id) {
                        document.getElementById("studentID").value = data.id;
                    }
                } catch (e) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:", e);
                }
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        function setupInputValidation() {
            const inputs = ['name', 'studentPhone', 'parentPhone', 'password'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('blur', validateInput);
                    input.addEventListener('input', saveDraft);
                }
            });
            
            const selects = ['grade', 'gov'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.addEventListener('change', saveDraft);
                }
            });
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        function validateInput(e) {
            const input = e.target;
            const value = input.value.trim();
            const errorElement = document.getElementById(`${input.id}Error`);
            
            if (!errorElement) return;
            
            let isValid = true;
            let errorMessage = "";
            
            switch(input.id) {
                case 'name':
                    isValid = value.split(" ").length >= 3;
                    errorMessage = "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø«Ù„Ø§Ø«ÙŠÙ‹Ø§";
                    break;
                    
                case 'studentPhone':
                    isValid = /^(010|011|012|015)\d{8}$/.test(value);
                    errorMessage = "Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015)";
                    break;
                    
                case 'parentPhone':
                    const studentPhone = document.getElementById('studentPhone').value.trim();
                    isValid = /^(010|011|012|015)\d{8}$/.test(value) && value !== studentPhone;
                    errorMessage = value === studentPhone ? 
                        "Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" : 
                        "Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015)";
                    break;
                    
                case 'password':
                    isValid = value.length >= 4;
                    errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";
                    break;
            }
            
            if (!isValid && value) {
                errorElement.textContent = errorMessage;
                errorElement.style.display = "block";
                input.style.borderColor = "var(--error-text)";
            } else {
                errorElement.style.display = "none";
                input.style.borderColor = isValid ? "#ddd" : "var(--error-text)";
            }
            
            return isValid;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ø³ÙˆØ¯Ø©
        function saveDraft() {
            const draftData = {
                name: document.getElementById("name").value.trim(),
                studentPhone: document.getElementById("studentPhone").value.trim(),
                parentPhone: document.getElementById("parentPhone").value.trim(),
                grade: document.getElementById("grade").value,
                governorate: document.getElementById("gov").value,
                password: document.getElementById("password").value,
                id: document.getElementById("studentID").value
            };
            
            localStorage.setItem("studentDraft", JSON.stringify(draftData));
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        async function checkPhoneDuplicate(phone) {
            try {
                const studentsRef = collection(db, "students");
                const q = query(studentsRef, where("studentPhone", "==", phone));
                const querySnapshot = await getDocs(q);
                
                return !querySnapshot.empty;
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±:", err);
                return false;
            }
        }

        // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        async function register() {
            // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const name = document.getElementById("name").value.trim();
            const sPhone = document.getElementById("studentPhone").value.trim();
            const pPhone = document.getElementById("parentPhone").value.trim();
            const grade = document.getElementById("grade").value;
            const gov = document.getElementById("gov").value;
            const pass = document.getElementById("password").value;
            const id = document.getElementById("studentID").value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!validateAll()) {
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            const isDuplicate = await checkPhoneDuplicate(sPhone);
            if (isDuplicate) {
                showMessage("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!", "error");
                return;
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const loader = document.getElementById("loader");
            const registerBtn = document.getElementById("registerBtn");
            loader.style.display = "block";
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            const studentData = {
                id: id,
                name: name,
                studentPhone: sPhone,
                parentPhone: pPhone,
                grade: grade,
                governorate: gov,
                password: pass,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };

            try {
                // Ø­ÙØ¸ ÙÙŠ Firebase
                const studentRef = doc(db, "students", id);
                await setDoc(studentRef, studentData);

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
                localStorage.setItem("studentData", JSON.stringify(studentData));
                localStorage.setItem("currentStudentId", id);
                localStorage.setItem("lastGrade", grade);
                
                // Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
                localStorage.removeItem("studentDraft");
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                document.getElementById("result").style.display = "block";
                document.getElementById("showID").innerText = id;
                document.getElementById("showPass").innerText = pass;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØ±Ù…
                document.querySelectorAll('input, select, button:not(#goPageBtn)').forEach(el => {
                    el.style.display = "none";
                });
                
                showMessage("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                
            } catch (err) {
                showMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + err.message, "error");
            } finally {
                loader.style.display = "none";
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        function validateAll() {
            const fields = [
                {id: 'name', test: (v) => v.split(" ").length >= 3, msg: "Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙƒØ§Ù…Ù„!"},
                {id: 'studentPhone', test: (v) => /^(010|011|012|015)\d{8}$/.test(v), msg: "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø§Ø²Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 010/011/012/015 ÙˆÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù…!"},
                {id: 'parentPhone', test: (v) => /^(010|011|012|015)\d{8}$/.test(v), msg: "Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ØºÙŠØ± ØµØ­ÙŠØ­!"},
                {id: 'grade', test: (v) => !!v, msg: "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ!"},
                {id: 'gov', test: (v) => !!v, msg: "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©!"},
                {id: 'password', test: (v) => v.length >= 4, msg: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"}
            ];

            for (const field of fields) {
                const element = document.getElementById(field.id);
                const value = element ? element.value : '';
                
                if (!field.test(value)) {
                    showMessage(field.msg, "error");
                    element.focus();
                    return false;
                }
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ
            const studentPhone = document.getElementById('studentPhone').value.trim();
            const parentPhone = document.getElementById('parentPhone').value.trim();
            
            if (studentPhone === parentPhone) {
                showMessage("Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±!", "error");
                return false;
            }

            return true;
        }

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØµÙ
        function goToGradePage() {
            const grade = localStorage.getItem("lastGrade");
            const pages = {
                "1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-1/",
                "2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-2/",
                "3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ": "/prep-3/",
                "1 Ø«Ø§Ù†ÙˆÙŠ": "/sec-1/",
                "2 Ø«Ø§Ù†ÙˆÙŠ": "/sec-2/",
                "3 Ø«Ø§Ù†ÙˆÙŠ": "/sec-3/"
            };

            if (grade && pages[grade]) {
                window.location.href = pages[grade];
            } else {
                showMessage("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ!", "error");
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(message, type = "info") {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                background: ${type === 'error' ? 'var(--error-bg)' : 'var(--success-bg)'};
                color: ${type === 'error' ? 'var(--error-text)' : 'var(--success-text)'};
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = "slideOut 0.3s ease";
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .warning {
                color: #ff9800;
                font-size: 14px;
                margin-top: 10px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>